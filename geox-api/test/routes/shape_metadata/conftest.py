# pylint: disable=redefined-outer-name,duplicate-code
"""Common fixtures."""
from typing import Any, Dict, Generator, List, Literal, TypedDict

import pytest
from geojson_pydantic import Polygon

from app.crud.shape import create_shape

from ..conftest import ExampleDbAbc

# Alice: 5 shapes: 3 in default, 2 non-default
# Bob: 1 shape default, 0 shape non-default - same org
# Carlos: 1 shape - diff org


class _PolygonDict(TypedDict):
    coordinates: List[List]
    type: Literal["Polygon"]


class _ShapeDict(TypedDict):
    geometry: _PolygonDict
    properties: Dict[str, Any]
    name: str
    user: str
    namespace: str


SHAPES: List[_ShapeDict] = [
    {
        "geometry": {
            "coordinates": [
                [
                    [-122.262496133, 37.811034921],
                    [-122.263324455, 37.806757455],
                    [-122.261722853, 37.804656381],
                    [-122.259848711, 37.803995272],
                    [-122.261389919, 37.801252919],
                    [-122.258969933, 37.798860828],
                    [-122.256463941, 37.799940299],
                    [-122.254298147, 37.800350458],
                    [-122.254985422, 37.80291284],
                    [-122.2521744, 37.804516549],
                    [-122.250222662, 37.804926984],
                    [-122.249757089, 37.80713043],
                    [-122.248872194, 37.808538051],
                    [-122.25195805, 37.808119482],
                    [-122.252792488, 37.807068519],
                    [-122.255966642, 37.806920538],
                    [-122.257200525, 37.80574966],
                    [-122.262496133, 37.811034921],
                ]
            ],
            "type": "Polygon",
        },
        "properties": {"description": "Lake Merritt"},
        "name": "pink-objective",
        "user": "alice",
        "namespace": "default",
    },
    {
        "geometry": {
            "coordinates": [
                [
                    [-72.285522512, 43.716927198],
                    [-72.286148631, 43.715802643],
                    [-72.28654475, 43.715182295],
                    [-72.286437623, 43.713082901],
                    [-72.285379238, 43.713181194],
                    [-72.285017246, 43.712320841],
                    [-72.284507936, 43.712108112],
                    [-72.283866447, 43.712883935],
                    [-72.282409357, 43.712326481],
                    [-72.28084594, 43.713926187],
                    [-72.28205265, 43.712092933],
                    [-72.28176267, 43.710901467],
                    [-72.280719765, 43.71001929],
                    [-72.278344642, 43.71115401],
                    [-72.273321657, 43.719210597],
                    [-72.274284142, 43.720083956],
                    [-72.275340729, 43.720534539],
                    [-72.275715912, 43.72118432],
                    [-72.276234361, 43.721383521],
                    [-72.276697084, 43.722676788],
                    [-72.275911123, 43.723766413],
                    [-72.276691522, 43.724017454],
                    [-72.278067565, 43.721503862],
                    [-72.277926412, 43.720356718],
                    [-72.277531319, 43.718673423],
                    [-72.277322315, 43.718437553],
                    [-72.27855943, 43.719399676],
                    [-72.27910413, 43.719556678],
                    [-72.279158077, 43.72066083],
                    [-72.278828943, 43.721286895],
                    [-72.280243139, 43.721441803],
                    [-72.280790508, 43.72174189],
                    [-72.280784057, 43.722135546],
                    [-72.281687366, 43.721937874],
                    [-72.282993556, 43.72103737],
                    [-72.283584194, 43.720678355],
                    [-72.285522512, 43.716927198],
                ]
            ],
            "type": "Polygon",
        },
        "properties": {
            "description": "Dartmouth cross country course",
        },
        "name": "convoluted-sledder",
        "user": "alice",
        "namespace": "default",
    },
    {
        "geometry": {
            "coordinates": [
                [
                    [-122.515244814, 37.781246929],
                    [-122.511616687, 37.766598462],
                    [-122.509408357, 37.74005562],
                    [-122.50186359, 37.700327778],
                    [-122.391264857, 37.706769931],
                    [-122.383273218, 37.719124049],
                    [-122.367910355, 37.714382741],
                    [-122.355110499, 37.726543424],
                    [-122.371791202, 37.732677917],
                    [-122.368369158, 37.740492204],
                    [-122.384421854, 37.757329145],
                    [-122.38482534, 37.772085761],
                    [-122.393790988, 37.798617967],
                    [-122.414440394, 37.807733856],
                    [-122.459787089, 37.80490674],
                    [-122.478548135, 37.808877869],
                    [-122.482144806, 37.799104771],
                    [-122.484170917, 37.794620573],
                    [-122.491664706, 37.787699188],
                    [-122.515244814, 37.781246929],
                ]
            ],
            "type": "Polygon",
        },
        "properties": {
            "description": "San Francisco",
        },
        "name": "isobaric-concentration",
        "user": "alice",
        "namespace": "new-namespace",
    },
    {
        "geometry": {
            "coordinates": [
                [
                    [-122.343100217, 37.80560894],
                    [-122.330511145, 37.799527861],
                    [-122.305669644, 37.793718925],
                    [-122.28256848, 37.794673471],
                    [-122.260454396, 37.78640294],
                    [-122.255375811, 37.789057965],
                    [-122.244875905, 37.784267294],
                    [-122.242837007, 37.778766578],
                    [-122.224547856, 37.764579488],
                    [-122.204824545, 37.741916642],
                    [-122.213319827, 37.74024589],
                    [-122.224369633, 37.747350239],
                    [-122.252518917, 37.74792417],
                    [-122.264047792, 37.744706966],
                    [-122.218908707, 37.699796655],
                    [-122.211472861, 37.700131112],
                    [-122.211003693, 37.70908193],
                    [-122.194952989, 37.713614775],
                    [-122.139759555, 37.736313994],
                    [-122.109431994, 37.749499598],
                    [-122.218926987, 37.870725404],
                    [-122.237823923, 37.862650999],
                    [-122.235548918, 37.854736875],
                    [-122.244714439, 37.853473399],
                    [-122.287960859, 37.852506984],
                    [-122.278281235, 37.828538017],
                    [-122.295362432, 37.830349946],
                    [-122.312477142, 37.828410482],
                    [-122.325853744, 37.823235523],
                    [-122.343100217, 37.80560894],
                ]
            ],
            "type": "Polygon",
        },
        "properties": {"description": "Oakland"},
        "user": "alice",
        "name": "short-bulldozer",
        "namespace": "new-namespace",
    },
    {
        "geometry": {
            "coordinates": [
                [
                    [-73.896930605, 40.891928139],
                    [-73.896129012, 40.890923571],
                    [-73.891944634, 40.890893181],
                    [-73.890981908, 40.891298292],
                    [-73.890229027, 40.892383655],
                    [-73.890211954, 40.89318306],
                    [-73.891259432, 40.893856934],
                    [-73.891790359, 40.894188667],
                    [-73.891274944, 40.895060195],
                    [-73.890770454, 40.895979008],
                    [-73.890522773, 40.896851192],
                    [-73.890007926, 40.897843837],
                    [-73.889707227, 40.898798432],
                    [-73.890521165, 40.89966132],
                    [-73.891457028, 40.899670721],
                    [-73.891025703, 40.900257699],
                    [-73.887417595, 40.902794932],
                    [-73.88774567, 40.906881636],
                    [-73.88693463, 40.908717044],
                    [-73.896707356, 40.910651484],
                    [-73.896228049, 40.904275798],
                    [-73.896375012, 40.900599152],
                    [-73.89681773, 40.897850177],
                    [-73.896077732, 40.895553975],
                    [-73.896376842, 40.893490944],
                    [-73.896930605, 40.891928139],
                ]
            ],
            "type": "Polygon",
        },
        "properties": {
            "description": "Van Cortlandt Park",
        },
        "user": "bob",
        "name": "thundering-use",
        "namespace": "default",
    },
    {
        "geometry": {
            "coordinates": [
                [
                    [-122.199135194, 37.813994432],
                    [-122.195581329, 37.810526647],
                    [-122.175517453, 37.807785198],
                    [-122.174916111, 37.810286529],
                    [-122.175519898, 37.812869206],
                    [-122.181725615, 37.818392498],
                    [-122.19152716, 37.814102899],
                    [-122.195399215, 37.813890472],
                    [-122.199135194, 37.813994432],
                ]
            ],
            "type": "Polygon",
        },
        "properties": {
            "description": "Joaquin Miller Park",
        },
        "name": "several-sword",
        "user": "carlos",
        "namespace": "default",
    },
]
"""
Random shapes generated by::

    [random_geojson().dict() for _ in range(6)]
"""


@pytest.fixture()
def db(abc_example_data: ExampleDbAbc) -> Generator[ExampleDbAbc, None, None]:
    data = abc_example_data
    for shp in SHAPES:
        user: DbExampleUser = getattr(data, shp["user"])  # type: ignore
        data.shapes[shp["name"]] = create_shape(
            data.conn,
            geom=Polygon.parse_obj(shp["geometry"]),
            properties=shp["properties"],
            name=shp["name"],
            user_id=user.id,
            organization_id=user.organization.id,
            namespace_id=user.organization.namespaces[shp["namespace"]].id,
        )

    # Overrides fastapi dependencies
    with data.dep_overrides():
        yield data
