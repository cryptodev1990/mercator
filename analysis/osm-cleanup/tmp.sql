-- -- Selects a generous region of lines
-- WITH matchable AS (
--     -- Got this from the "geometry" property of a Feature object
--   SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
-- )
-- , ways AS (
-- SELECT w.geom AS geom
--  FROM planet_osm_line w
--  JOIN matchable ON ST_Intersects(w.geom, ST_Buffer(matchable.geom, 0.005))
-- )
-- , ok AS (
-- SELECT geom
-- FROM ways
-- UNION ALL
-- SELECT * FROM matchable
-- )
-- SELECT St_AsGeoJson(ST_Collect(geom)) AS geom
-- FROM ok
-- ;



-- WITH matchable AS (
--     -- Got this from the "geometry" property of a Feature object
--   SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
-- )
-- , ways AS (
-- SELECT w.geom AS geom
--  FROM planet_osm_line w
--  JOIN matchable ON ST_Intersects(w.geom, matchable.geom)
-- )
-- , ok AS (
-- SELECT geom
-- FROM ways
-- UNION ALL
-- SELECT * FROM matchable
-- )
-- , ok1 AS (
-- SELECT ST_ConvexHull(ST_Collect(geom)) AS geom
-- FROM ok
-- UNION ALL
-- SELECT geom FROM ok
-- )
-- SELECT St_AsGeoJson(ST_collect(geom)) FROM ok1
-- ;




-- WITH matchable AS (
--     -- Got this from the "geometry" property of a Feature object
--   SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
-- )
-- , ways AS (
-- SELECT ST_Intersection(ST_Collect(w.geom), ST_Buffer(matchable.geom, 0.005)) AS geom
--  FROM planet_osm_line w
--  JOIN matchable ON ST_Intersects(w.geom, matchable.geom)
--  GROUP BY matchable.geom
-- )
-- , ok AS (
-- SELECT geom
-- FROM ways
-- UNION ALL
-- SELECT * FROM matchable
-- )
-- SELECT St_AsGeoJson(St_ConvexHull(geom)) AS geom
-- FROM ok
-- ;
-- -- 



-- -- -- High res trace
-- WITH matchable AS (
--     -- Got this from the "geometry" property of a Feature object
--   SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
-- )
-- , points AS (
-- SELECT ST_DumpPoints(ST_Segmentize(ST_ExteriorRing(geom)::GEOGRAPHY, 5)::geometry) AS dp
-- FROM matchable
-- )
-- SELECT St_AsGeoJson(ST_Collect((dp).geom)) As wktnode
-- FROM points
-- ;

-- Snap high res trace to all the lines
WITH hr_trace AS (
  WITH matchable AS (
      -- Got this from the "geometry" property of a Feature object
    SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
  )
  , points AS (
  SELECT ST_DumpPoints(ST_Segmentize(ST_ExteriorRing(geom)::GEOGRAPHY, 5)::geometry) AS dp
  FROM matchable
  )
  SELECT ST_Collect((dp).geom) As geom
  FROM points
)
, clipper AS (
  WITH matchable AS (
      -- Got this from the "geometry" property of a Feature object
    SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
  )
  , ways AS (
  SELECT ST_Intersection(ST_Collect(w.geom), ST_Buffer(matchable.geom, 0.005)) AS geom
   FROM planet_osm_line w
   JOIN matchable ON ST_Intersects(w.geom, matchable.geom)
   GROUP BY matchable.geom
  )
  , ok AS (
  SELECT geom
  FROM ways
  UNION ALL
  SELECT * FROM matchable
  )
  SELECT St_ConvexHull(geom) AS geom
  FROM ok
)
SELECT ST_AsGeoJson(geom) FROM hr_trace;

-- -- WIP
-- CREATE TEMPORARY TABLE ix AS
-- WITH matchable AS (
--     -- Got this from the "geometry" property of a Feature object
--   SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
-- )
-- , ways AS (
-- SELECT w.geom AS geom
--  FROM planet_osm_line w
--  JOIN matchable ON ST_Intersects(w.geom, ST_Buffer(matchable.geom, 0.005))
-- )
-- , ok AS (
-- SELECT geom
-- FROM ways
-- )
-- 
-- , shapes AS (
-- SELECT DISTINCT ST_Intersection(a.geom, b.geom) AS pt
-- FROM ok a
-- CROSS JOIN ok b
-- WHERE a.geom::VARCHAR != b.geom::VARCHAR
--   AND a.geom::VARCHAR > b.geom::VARCHAR
-- )
-- SELECT ST_AsGeoJson(ST_Collect(pt)) AS shp
-- FROM shapes
-- WHERE (ST_AsGeoJson(pt)::JSON->>'type')::VARCHAR IN ('Point', 'MultiPoint')
-- ;
-- 
-- CREATE TEMPORARY TABLE high_res_points AS
-- WITH matchable AS (
--     -- Got this from the "geometry" property of a Feature object
--   SELECT ST_GeomFromGeoJSON('{ "coordinates": [ [ [ -122.5084923687725, 37.77007797689627 ], [ -122.50657293256728, 37.77238049401491 ], [ -122.50662678399432, 37.77266075769533 ], [ -122.50677671126277, 37.77312618460844 ], [ -122.50720972569206, 37.77389111912972 ], [ -122.50761153077153, 37.774374435255815 ], [ -122.50787834011459, 37.77480347724796 ], [ -122.508253709039, 37.77523000153184 ], [ -122.50879846517932, 37.77534811997863 ], [ -122.50955299710597, 37.77534763628351 ], [ -122.51023262659315, 37.775154931888494 ], [ -122.51083392673188, 37.77489460602702 ], [ -122.51127905773227, 37.774549921954424 ], [ -122.51142984172793, 37.77403129661016 ], [ -122.51142984172793, 37.773543915102714 ], [ -122.51139581741721, 37.77302479899136 ], [ -122.51130953274436, 37.7723267049371 ], [ -122.51097700018236, 37.77152711987727 ], [ -122.51061460455627, 37.77107687180467 ], [ -122.50997046805516, 37.77055783511746 ], [ -122.50917750579195, 37.770200650624844 ], [ -122.5084923687725, 37.77007797689627 ] ] ], "type": "Polygon" }') AS geom
-- )
-- , points AS (
-- SELECT ST_DumpPoints(ST_Segmentize(ST_ExteriorRing(geom)::GEOGRAPHY, 10)::geometry) AS dp
-- FROM matchable
-- )
-- SELECT (dp).geom AS pt
-- FROM points
-- ;
-- SELECT ST_AsGeoJson(ST_Collect(ST_ClosestPoint(geom, pt))) AS pts
-- FROM high_res_points
-- CROSS JOIN ix
-- ;
-- 
-- 
-- -- I think the best strategy might be
-- -- break the shape up into points 
